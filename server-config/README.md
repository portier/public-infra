# Portier project server configuration

This directory contains the [NixOS](https://nixos.org) 20.03 configuration for
the server run by the Portier project.

We use NixOS for several reasons:

 - The entire server configuration can be documented publically. This helps us
   build trust in our public broker, which is important for a security
   component like Portier.

 - Mutable state on the server is minimized. This benefits the above point
   about documentation and trust, but also means less surprises for admins.

 - NixOS has excellent sandboxing capabilities, which is important for a
   security component like Portier.

Note that the configuration here may not be out-of-the-box suitable to apply to
your own server, but it should be simple enough to serve as an example.
(Especially the `./portier` subdirectory is reusable, containing a Nixpkgs
overlay and NixOS modules. We may upstream parts of it in the future.)

We run our server on [Hetzner Cloud](https://www.hetzner.com/cloud) on a
CX11-CEPH instance (smallest configuration) in the Nuremberg data center. The
instance uses CEPH storage, because we value reliability over performance.

The procedure for setting up this server is:

 - Prepare an `admins.nix` with the SSH public keys and IP addresses that will
   have access to the server. (We deliberately keep these outside the
   repository.)

 - Create the CX11-CEPH instance from the Hetzner Cloud console. Use any OS
   image for now, and leave the volume and network sections empty, but set a
   (temporary) SSH key-pair if you want. Also give it a descriptive name. (We
   prefer using the fully-qualified hostname.)

 - Prepare a `local-configuration.nix`. You may need to log in to the server
   and take note of some settings generated by Hetzner, such as the IPv6
   configuration.

 - Update DNS records for the broker and demo to point to the new server IPs.

 - In the Hetzner Cloud console, go to 'ISO Images' and mount NixOS 20.03.

 - Go to 'Power' and perform a power cycle.

 - Open the server console. The NixOS installer should have booted into a
   shell.

 - Use the server console to follow the regular NixOS installation steps. These
   are the commands from the manual summary near exactly:
   https://nixos.org/nixos/manual/index.html#sec-installation-summary

   - When partitioning the disk, use MBR instead of GPT. Instead of the 8 GiB
     swap in the manual examples, use 2 GiB (of the 20 GiB disk).

   - Don't copy in the repository config yet, but simply generate a config per
     the manual. Set the following options in the generated config:

     ```
     boot.loader.grub.device = "/dev/sda";
     services.openssh.enable = true;
     services.openssh.permitRootLogin = "yes";
     ```

   - `nixos-install` will ask you to set a root password. This is a temporary
     password which will be unset by the end of these steps.

   - Instead of `reboot`, do `poweroff`.

 - Once powered off, use the Hetzner Cloud console to unmount the NixOS
   installer ISO. Then start the server again.

 - Check that you can SSH into the server as `root`, with the password you
   entered during `nixos-install`.

 - Switch to the `nixos-20.03-small` channel:

   ```
   nix-channel --add https://nixos.org/channels/nixos-20.03-small nixos
   nix-channel --update
   ```

 - Copy the repository config to `/etc/nixos` (using e.g. rsync), overwriting
   `configuration.nix` and adding the other files. Keep your generated
   `hardware-configuration.nix` as is.

 - Create a directory for credentials: `mkdir -m 0700 /private`

 - Create `/private/smtp-credentials.toml` containing just `smtp_username` and
   `smtp_password`. We deliberately keep these outside of the repository AND
   outside the world-readable Nix store.

 - Create `/private/github-token.txt` containing just the GitHub personal
   access token. This token is only used to access public data, so doesn't need
   any special access.

 - Create `/private/webhook-secret.txt` containing a random secret (something
   like `pwgen -s 64`) used to protect the webhook calls for continuous
   deployment.

 - Run `nixos-rebuild boot --upgrade` to build the configuration and apply it
   on next startup. (We can't apply it immediately, because we switch from
   iptables to nftables, but the kernel modules are difficult to unload.)

 - Reboot.

 - Check that you can now login using your SSH key-pair as the `admin` user.

 - Check that all services are working properly.
